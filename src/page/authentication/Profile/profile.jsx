import React, { useState, useEffect } from "react";
import Header from "../../../components/Navigation/Header";
import Footer from "../../../components/Footer/Footer";
import {
    getUserInformation,
    updateUserInformation,
    updateAvatarProfile,
} from "../../../services/cusomerService"; // s·ª≠a l·∫°i ƒë√∫ng t√™n
import "./profile.css";


const BASE_URL = "http://localhost:8082";


const ProfileView = () => {
    const [profile, setProfile] = useState(null);
    const [formData, setFormData] = useState({
        firstName: "",
        lastName: "",
        email: "",
        phone: "",
        birthday: "",
        imgPath: "",
    });
    const [imageFile, setImageFile] = useState(null);
    const [isEditingBasicInfo, setIsEditingBasicInfo] = useState(false);
    const [isEditingEmail, setIsEditingEmail] = useState(false);
    const [isEditingPhone, setIsEditingPhone] = useState(false);
    const [message, setMessage] = useState("");


    // L·∫•y userID t·ª´ localStorage b·∫±ng if/else
    let userID = null;
    const stored = localStorage.getItem("user");
    if (stored) {
        try {
            const parsed = JSON.parse(stored);
            // √©p ki·ªÉu Number v√† ki·ªÉm tra
            const idNum = Number(parsed.id);
            if (Number.isInteger(idNum) && idNum > 0) {
                userID = idNum;
                console.log("userID:", userID);
            } else {
                console.error("ID ng∆∞·ªùi d√πng kh√¥ng h·ª£p l·ªá trong localStorage:", parsed.id);
            }
        } catch (err) {
            console.error("D·ªØ li·ªáu user trong localStorage kh√¥ng h·ª£p l·ªá:", err);
        }
    } else {
        console.warn("Kh√¥ng t√¨m th·∫•y key ‚Äòuser‚Äô trong localStorage");
    }


    // 1. Trong fetchProfile, sau khi setProfile v√† setFormData, l∆∞u v·ªÅ localStorage:
    const fetchProfile = async (id) => {
        setMessage("");
        try {
            const data = await getUserInformation(id);
            console.log("Server tr·∫£ v·ªÅ:", data);
            setProfile(data);
            setFormData({
                firstName: data.firstName || "",
                lastName:  data.lastName  || "",
                email:     data.email     || "",
                phone:     data.phone     || "",
                birthday:  data.birthday  || "",
                imgPath:   data.imgPath   || data.ImgPath || "",
            });


            // **L∆ØU V·ªÄ localStorage**
            localStorage.setItem("user", JSON.stringify({
                id:        id,
                firstName: data.firstName,
                lastName:  data.lastName,
                email:     data.email,
                phone:     data.phone,
                birthday:  data.birthday,
                picture:   data.imgPath || data.ImgPath || ""
            }));
            window.dispatchEvent(new Event("userInfoChanged"));
        } catch (err) {
            console.error("L·ªói khi t·∫£i th√¥ng tin:", err);
            setMessage("L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng: " + err.message);
        }
    };




    // --- 2. G·ªçi fetchProfile ngay khi component mount ---
    useEffect(() => {
        if (!userID) {
            setMessage("ID ng∆∞·ªùi d√πng kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng t√¨m th·∫•y.");
            return;
        }
        // show t·∫°m data c≈© t·ª´ localStorage (n·∫øu mu·ªën)
        // r·ªìi fetch b·∫£n m·ªõi nh·∫•t t·ª´ server:
        fetchProfile(userID);
    }, [userID]);


    // --- 3. C√°c handler ---
    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData((prev) => ({ ...prev, [name]: value }));
    };


    const handleImageChange = (e) => {
        if (e.target.files.length) {
            const file = e.target.files[0];
            setImageFile(file);
            setFormData((prev) => ({
                ...prev,
                imgPath: URL.createObjectURL(file),
            }));
        }
    };


    // --- 4. Update profile info ---
    // 2. Trong updateProfileInfo, sau khi c·∫≠p nh·∫≠t th√†nh c√¥ng, c≈©ng ghi l·∫°i to√†n b·ªô user:
    const updateProfileInfo = async () => {
        if (!profile) {
            setMessage("Kh√¥ng t√¨m th·∫•y th√¥ng tin profile.");
            return false;
        }
        setMessage("");


        const userDTO = {
            firstName: formData.firstName,
            lastName:  formData.lastName,
            birthday:  formData.birthday,
            email:     formData.email,
            phone:     formData.phone,
            imgPath:   formData.imgPath,
        };


        const res = await updateUserInformation(userID, userDTO);
        if (!res.success) {
            setMessage(res.message);
            return false;
        }


        // c·∫≠p nh·∫≠t state
        setProfile(prev => ({ ...prev, ...userDTO }));
        setMessage("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng üéâ");


        // **L∆ØU V·ªÄ localStorage**
        const stored = localStorage.getItem("user");
        if (stored) {
            try {
                const usr = JSON.parse(stored);
                // ghi ƒë√® c√°c field m·ªõi
                usr.firstName = userDTO.firstName;
                usr.lastName  = userDTO.lastName;
                usr.email     = userDTO.email;
                usr.phone     = userDTO.phone;
                usr.birthday  = userDTO.birthday;
                usr.picture   = userDTO.imgPath;
                localStorage.setItem("user", JSON.stringify(usr));
                window.dispatchEvent(new Event("userInfoChanged"));
            } catch (e) {
                console.error("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t localStorage:", e);
            }
        }


        return true;
    };


    // --- 5. Update avatar ---
    const updateAvatar = async () => {
        if (!profile) {
            setMessage("Kh√¥ng t√¨m th·∫•y th√¥ng tin profile.");
            return false;
        }
        if (!imageFile) {
            setMessage("Vui l√≤ng ch·ªçn file avatar.");
            return false;
        }


        // validate lo·∫°i file
        const validTypes = ["image/jpeg", "image/png", "image/gif"];
        if (!validTypes.includes(imageFile.type)) {
            setMessage("Ch·ªâ cho ph√©p JPEG, PNG, GIF.");
            return false;
        }
        if (imageFile.size > 5 * 1024 * 1024) {
            setMessage("File qu√° l·ªõn (>5MB).");
            return false;
        }


        setMessage("");
        const fd = new FormData();
        fd.append("avatar", imageFile);


        try {
            const res = await updateAvatarProfile(userID, fd);
            if (!res.success) {
                setMessage(res.message);
                return false;
            }


            // build URL ƒë·∫ßy ƒë·ªß
            const url = res.avatarUrl?.startsWith("http")
                ? res.avatarUrl
                : BASE_URL + res.avatarUrl;


            // 1) C·∫≠p nh·∫≠t state
            setFormData(prev => ({ ...prev, imgPath: url }));
            setProfile(prev => ({ ...prev, imgPath: url }));
            setMessage("C·∫≠p nh·∫≠t avatar th√†nh c√¥ng üéâ");


            // 2) L∆∞u v√†o localStorage
            const stored = localStorage.getItem("user");
            if (stored) {
                try {
                    const usr = JSON.parse(stored);
                    usr.picture = url;            // ho·∫∑c usr.imgPath = url n·∫øu b·∫°n l∆∞u key kh√°c
                    localStorage.setItem("user", JSON.stringify(usr));
                } catch (e) {
                    console.error("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t localStorage:", e);
                }
            }


            // 3) (T√πy ch·ªçn) Dispatch event ƒë·ªÉ component kh√°c l·∫Øng nghe
            window.dispatchEvent(new Event("avatarChanged"));
            window.dispatchEvent(new Event("userInfoChanged"));
            return true;
        } catch (err) {
            console.error("L·ªói khi c·∫≠p nh·∫≠t avatar:", err);
            setMessage(err.message || "L·ªói khi c·∫≠p nh·∫≠t avatar.");
            return false;
        }
    };


    // --- 6. Save all changes ---
    const handleSaveChanges = async () => {
        let ok = false;
        if (isEditingBasicInfo || isEditingEmail || isEditingPhone) {
            ok = await updateProfileInfo();
            if (!ok) return;
        }
        if (imageFile) {
            ok = await updateAvatar();
            if (!ok) return;
        }
        if (ok) {
            setIsEditingBasicInfo(false);
            setIsEditingEmail(false);
            setIsEditingPhone(false);
            setImageFile(null);
        }
    };


    // --- Guard n·∫øu ch∆∞a c√≥ profile ---
    if (!profile) {
        return (
            <div className="pv-loading">
                {message || "ƒêang t·∫£i th√¥ng tin ng∆∞·ªùi d√πng..."}
            </div>
        );
    }


    return (
        <>
            <Header />
            <div className="pv-profile-page">
                <div className="pv-profile-container">
                    <div className="pv-profile-header">
                        <button
                            className="pv-edit-btn"
                            onClick={() => {
                                setIsEditingBasicInfo(true);
                                setIsEditingEmail(false);
                                setIsEditingPhone(false);
                            }}
                        >
                            Edit Profile Info
                        </button>
                        <button
                            className="pv-edit-btn"
                            onClick={() => {
                                setIsEditingEmail(true);
                                setIsEditingBasicInfo(false);
                                setIsEditingPhone(false);
                            }}
                        >
                            Change Email
                        </button>
                        <button
                            className="pv-edit-btn"
                            onClick={() => {
                                setIsEditingPhone(true);
                                setIsEditingBasicInfo(false);
                                setIsEditingEmail(false);
                            }}
                        >
                            Change Phone
                        </button>
                        <button className="pv-save-btn-main" onClick={handleSaveChanges}>
                            Save Changes
                        </button>
                    </div>


                    <div className="pv-edit-wrapper">
                        {/* Avatar */}
                        <div className="pv-details-section">
                            <div className="pv-image-wrapper pv-image-upload">
                                {formData.imgPath ? (
                                    <img
                                        src={formData.imgPath}
                                        alt="Profile"
                                        className="pv-image-preview"
                                        style={{ width: 100, height: 100, objectFit: "cover" }}
                                    />
                                ) : (
                                    <div>Kh√¥ng c√≥ ·∫£nh ƒë·∫°i di·ªán</div>
                                )}
                                <label className="edit-overlay">
                                    <i className="icon-pencil" /> Edit
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onChange={handleImageChange}
                                    />
                                </label>
                            </div>


                            {/* Basic Info */}
                            <div className="pv-info-section">
                                {isEditingBasicInfo ? (
                                    <>
                                        <div className="pv-field-row">
                                            <label className="pv-label">First Name:</label>
                                            <input
                                                className="pv-input"
                                                name="firstName"
                                                value={formData.firstName}
                                                onChange={handleChange}
                                            />
                                        </div>
                                        <div className="pv-field-row">
                                            <label className="pv-label">Last Name:</label>
                                            <input
                                                className="pv-input"
                                                name="lastName"
                                                value={formData.lastName}
                                                onChange={handleChange}
                                            />
                                        </div>
                                        <div className="pv-field-row">
                                            <label className="pv-label">Birthday:</label>
                                            <input
                                                className="pv-input"
                                                type="date"
                                                name="birthday"
                                                value={formData.birthday}
                                                onChange={handleChange}
                                            />
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="pv-display-row">
                                            <span className="pv-label">First Name:</span>{" "}
                                            {profile.firstName}
                                        </div>
                                        <div className="pv-display-row">
                                            <span className="pv-label">Last Name:</span>{" "}
                                            {profile.lastName}
                                        </div>
                                        <div className="pv-display-row">
                                            <span className="pv-label">Birthday:</span>{" "}
                                            {profile.birthday}
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>


                        {/* Email */}
                        {isEditingEmail && (
                            <div className="pv-email-section pv-section-show">
                                <div className="pv-field-row">
                                    <label className="pv-label">New Email:</label>
                                    <input
                                        className="pv-input"
                                        type="email"
                                        name="email"
                                        value={formData.email}
                                        onChange={handleChange}
                                    />
                                </div>
                            </div>
                        )}


                        {/* Phone */}
                        {isEditingPhone && (
                            <div className="pv-phone-section pv-section-show">
                                <div className="pv-field-row">
                                    <label className="pv-label">New Phone:</label>
                                    <input
                                        className="pv-input"
                                        name="phone"
                                        value={formData.phone}
                                        onChange={handleChange}
                                    />
                                </div>
                            </div>
                        )}


                        {message && <p className="pv-message">{message}</p>}
                    </div>
                </div>
            </div>
            <Footer />
        </>
    );
};


export default ProfileView;

